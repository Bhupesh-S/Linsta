// Stories API service
import AsyncStorage from '@react-native-async-storage/async-storage';
import { getApiUrl } from './api';

export interface StoryUser {
  id: string;
  name: string;
  email: string;
  avatar: string;
  profileImageUrl?: string;
}

export interface StoryItem {
  id: string;
  mediaUrl: string;
  mediaType: 'image' | 'video';
  caption?: string;
  backgroundColor?: string;
  duration: number;
  viewCount: number;
  hasViewed: boolean;
  timestamp: string;
  expiresAt: string;
}

export interface UserStories {
  user: StoryUser;
  stories: StoryItem[];
  isOwn: boolean;
}

export interface CreateStoryData {
  mediaUrl: string;
  mediaType: 'image' | 'video';
  caption?: string;
  backgroundColor?: string;
  duration?: number;
}

// Helper to get authorization headers
const getAuthHeaders = async () => {
  const token = await AsyncStorage.getItem('token');
  if (!token) {
    console.warn('‚ö†Ô∏è No token found in AsyncStorage');
    throw new Error('No authentication token found');
  }
  console.log('üîë Token retrieved for stories:', token.substring(0, 20) + '...');
  return {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`,
  };
};

export const storiesApi = {
  // Get all active stories
  getStories: async (): Promise<UserStories[]> => {
    console.log('üì± Fetching stories...');
    try {
      const apiUrl = await getApiUrl();
      const headers = await getAuthHeaders();
      const response = await fetch(`${apiUrl}/api/stories`, {
        method: 'GET',
        headers,
      });

      if (!response.ok) {
        const error = await response.json();
        console.error('‚ùå Get stories error:', error);
        throw new Error(error.error || 'Failed to fetch stories');
      }

      const data = await response.json();
      console.log('‚úÖ Stories fetched successfully:', data.stories.length);
      return data.stories;
    } catch (error: any) {
      console.error('‚ùå Get stories error:', error);
      throw error;
    }
  },

  // Get my stories
  getMyStories: async (): Promise<StoryItem[]> => {
    console.log('üì± Fetching my stories...');
    try {
      const apiUrl = await getApiUrl();
      const headers = await getAuthHeaders();
      const response = await fetch(`${apiUrl}/api/stories/my-stories`, {
        method: 'GET',
        headers,
      });

      if (!response.ok) {
        const error = await response.json();
        console.error('‚ùå Get my stories error:', error);
        throw new Error(error.error || 'Failed to fetch my stories');
      }

      const data = await response.json();
      console.log('‚úÖ My stories fetched successfully:', data.stories.length);
      return data.stories;
    } catch (error: any) {
      console.error('‚ùå Get my stories error:', error);
      throw error;
    }
  },

  // Create a story
  createStory: async (storyData: CreateStoryData): Promise<StoryItem> => {
    console.log('üì± Creating story...');
    try {
      const apiUrl = await getApiUrl();
      const headers = await getAuthHeaders();
      const response = await fetch(`${apiUrl}/api/stories`, {
        method: 'POST',
        headers,
        body: JSON.stringify(storyData),
      });

      if (!response.ok) {
        const error = await response.json();
        console.error('‚ùå Create story error:', error);
        throw new Error(error.error || 'Failed to create story');
      }

      const data = await response.json();
      console.log('‚úÖ Story created successfully');
      return data.story;
    } catch (error: any) {
      console.error('‚ùå Create story error:', error);
      throw error;
    }
  },

  // Create story with media upload
  createStoryWithMedia: async (
    mediaFile: { uri: string; type: string; name: string },
    caption?: string,
    backgroundColor?: string,
    duration?: number
  ): Promise<StoryItem> => {
    console.log('üì± Creating story with media...');
    try {
      const apiUrl = await getApiUrl();
      const token = await AsyncStorage.getItem('token');
      const formData = new FormData();
      
      // Add media file with proper format for React Native
      formData.append('media', {
        uri: mediaFile.uri,
        type: mediaFile.type,
        name: mediaFile.name,
      } as any);
      
      if (caption) formData.append('caption', caption);
      if (backgroundColor) formData.append('backgroundColor', backgroundColor);
      if (duration) formData.append('duration', duration.toString());

      console.log('üì§ Uploading story media:', mediaFile.name);

      const response = await fetch(`${apiUrl}/api/stories/upload`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          // Don't set Content-Type for FormData, browser will set it with boundary
        },
        body: formData,
      });

      if (!response.ok) {
        const error = await response.json();
        console.error('‚ùå Create story with media error:', error);
        throw new Error(error.error || 'Failed to create story with media');
      }

      const data = await response.json();
      console.log('‚úÖ Story with media created successfully');
      return data.story;
    } catch (error: any) {
      console.error('‚ùå Create story with media error:', error);
      throw error;
    }
  },

  // View a story
  viewStory: async (storyId: string): Promise<void> => {
    console.log('üì± Viewing story...');
    try {
      const apiUrl = await getApiUrl();
      const headers = await getAuthHeaders();
      const response = await fetch(`${apiUrl}/api/stories/${storyId}/view`, {
        method: 'POST',
        headers,
      });

      if (!response.ok) {
        const error = await response.json();
        console.error('‚ùå View story error:', error);
        throw new Error(error.error || 'Failed to view story');
      }

      console.log('‚úÖ Story viewed successfully');
    } catch (error: any) {
      console.error('‚ùå View story error:', error);
      throw error;
    }
  },

  // Delete a story
  deleteStory: async (storyId: string): Promise<void> => {
    console.log('üì± Deleting story...');
    try {
      const apiUrl = await getApiUrl();
      const headers = await getAuthHeaders();
      const response = await fetch(`${apiUrl}/api/stories/${storyId}`, {
        method: 'DELETE',
        headers,
      });

      if (!response.ok) {
        const error = await response.json();
        console.error('‚ùå Delete story error:', error);
        throw new Error(error.error || 'Failed to delete story');
      }

      console.log('‚úÖ Story deleted successfully');
    } catch (error: any) {
      console.error('‚ùå Delete story error:', error);
      throw error;
    }
  },

  // Get story viewers
  getStoryViewers: async (storyId: string): Promise<{ viewCount: number; viewers: any[] }> => {
    console.log('üì± Fetching story viewers...');
    try {
      const apiUrl = await getApiUrl();
      const headers = await getAuthHeaders();
      const response = await fetch(`${apiUrl}/api/stories/${storyId}/viewers`, {
        method: 'GET',
        headers,
      });

      if (!response.ok) {
        const error = await response.json();
        console.error('‚ùå Get story viewers error:', error);
        throw new Error(error.error || 'Failed to fetch story viewers');
      }

      const data = await response.json();
      console.log('‚úÖ Story viewers fetched successfully');
      return data;
    } catch (error: any) {
      console.error('‚ùå Get story viewers error:', error);
      throw error;
    }
  },
};
